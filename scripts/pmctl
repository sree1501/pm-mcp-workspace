#!/usr/bin/env bash
set -euo pipefail

# Resolve symlinks to find the real script location
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do
  DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"
  SOURCE="$(readlink "$SOURCE")"
  [[ "$SOURCE" != /* ]] && SOURCE="$DIR/$SOURCE"
done

ROOT="$(cd -P "$(dirname "$SOURCE")/.." && pwd)"
LOG_DIR="$ROOT/.logs"
PID_DIR="$ROOT/.pids"

mkdir -p "$LOG_DIR" "$PID_DIR"

PM_CMD="cd \"$ROOT/mcp/pm\" && uv run python pm_server.py"
KB_CMD="cd \"$ROOT/mcp/kb\" && uv run python kb_mcp_server.py"

start_one () {
  local name="$1"; shift
  local cmd="$*"
  local pidfile="$PID_DIR/$name.pid"
  local logfile="$LOG_DIR/$name.log"

  if [[ -f "$pidfile" ]] && kill -0 "$(cat "$pidfile")" 2>/dev/null; then
    echo "✅ $name already running (PID $(cat "$pidfile"))"
    return 0
  fi

  echo "▶️  Starting $name..."
  nohup bash -lc "$cmd" > "$logfile" 2>&1 &
  echo $! > "$pidfile"
  sleep 0.3

  if kill -0 "$(cat "$pidfile")" 2>/dev/null; then
    echo "✅ $name started (PID $(cat "$pidfile"))  log: $logfile"
  else
    echo "❌ $name failed to start. See: $logfile"
    rm -f "$pidfile"
    exit 1
  fi
}

stop_one () {
  local name="$1"
  local pidfile="$PID_DIR/$name.pid"

  if [[ ! -f "$pidfile" ]]; then
    echo "ℹ️  $name not running (no pid)"
    return 0
  fi

  local pid
  pid="$(cat "$pidfile")"
  if kill -0 "$pid" 2>/dev/null; then
    echo "⏹️  Stopping $name (PID $pid)..."
    kill "$pid" || true
    sleep 0.3
  fi
  rm -f "$pidfile"
  echo "✅ $name stopped"
}

status_one () {
  local name="$1"
  local pidfile="$PID_DIR/$name.pid"
  if [[ -f "$pidfile" ]] && kill -0 "$(cat "$pidfile")" 2>/dev/null; then
    echo "✅ $name running (PID $(cat "$pidfile"))"
  else
    echo "⛔ $name not running"
  fi
}

case "${1:-}" in
  start)
    start_one pm_mcp "$PM_CMD"
    start_one kb_mcp "$KB_CMD"
    ;;
  stop)
    stop_one kb_mcp
    stop_one pm_mcp
    ;;
  status)
    status_one pm_mcp
    status_one kb_mcp
    ;;
  logs)
    echo "PM log: $LOG_DIR/pm_mcp.log"
    echo "KB log: $LOG_DIR/kb_mcp.log"
    ;;
  *)
    echo "Usage: pmctl {start|stop|status|logs}"
    exit 1
    ;;
esac
